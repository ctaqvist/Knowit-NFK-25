# 153 implement tls

## Scope

1. In this ticket, TLS (e.g. HTTPS and WSS) was implemented to encrypt data transfer.
2. In this ticket, only the data channel has ben changed using TLS. This change does not affect streaming.

## What have been done

The rest API is now using https.
The websocket (for data/commands) is now using wss.

## How has it been done

This has been done using an reverse proxy, meaning the codebase remains unaffected. The only change is that app.js cannot use port 80, on the server it was changed to 8080.

The server uses nginx and listens on port 80 and 443.

- If client connects on port 80 it will be met by 301 - Moved permanently. (A web browser should redirect to port 443)
- If a client connects on port 443 it will be served internally from the app.js on port 8080.

### Exactly what I have done

1. Installed nginx and certbot
2. Created a simple nginx-config in `/etc/nginx/sites-available/terrax9`

```
server {
    listen 80;
    server_name terrax9.se www.terrax9.se;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

3. Copied it from `/etc/nginx/sites-available/terrax9` to `/etc/nginx/sites-enabled/terrax9`
4. Run this command `certbot --nginx -d terrax9.se -d www.terrax9.se` to automatically create ssl certificates with auto renewale

The final nginx-config looks like this:
(Note that some parts are autogenerated by certbot)

As you can see it listens on 443 and uses the TLS certificate.
Note that we are using TLS and the naming uses ssl for reasons like backwards compability.

```

server {
    server_name terrax9.se www.terrax9.se;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/terrax9.se/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/terrax9.se/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = www.terrax9.se) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = terrax9.se) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name terrax9.se www.terrax9.se;
    return 404; # managed by Certbot
}

```